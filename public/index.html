<!doctype html>
<html lang="nl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ongeval Simulatie — A-Frame</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: system-ui, Arial;
            background: #0b1220;
        }

        /* Forceer a-scene fullscreen zodat je de simulatie ziet */
        a-scene {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        /* UI panel: strakke gaming look */
        #panel {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 12px;
            background: linear-gradient(180deg, rgba(20, 20, 30, 0.98), rgba(12, 12, 20, 0.95));
            color: #e6eef8;
            padding: 20px 22px;
            border-radius: 14px;
            box-shadow: 0 10px 60px rgba(0, 0, 0, 0.65);
            z-index: 200;
            max-width: 980px;
            width: calc(100vw - 40px);
            display: none;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.06);
            font-size: 18px;
        }

        #message {
            margin: 14px 0;
            white-space: pre-wrap;
            line-height: 1.4;
            font-size: 18px;
        }

        .btn {
            padding: 14px 20px;
            border-radius: 12px;
            border: 0;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
            font-size: 18px;
            min-width: 160px;
            display: inline-block;
            margin: 6px;
        }

        .btn-ok {
            background: linear-gradient(180deg, #2f80ed, #1b6fd4);
            color: white;
        }

        .btn-bad {
            background: linear-gradient(180deg, #bdc3c7, #95a5a6);
            color: white;
        }

        .btn-neutral {
            background: linear-gradient(180deg, #3a3f4a, #2a2d33);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        @media (max-width:600px) {
            #panel {
                top: 8px;
                padding: 14px;
                font-size: 16px;
            }

            .btn {
                font-size: 16px;
                padding: 12px 16px;
                min-width: 120px;
            }
        }

        #phone {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 480px;
            background: #222;
            border-radius: 30px;
            border: 4px solid #000;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.6);
            display: none;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px 10px;
            color: white;
            z-index: 70;
        }

        #phoneScreen {
            flex: 1;
            background: #111;
            border-radius: 20px;
            padding: 15px;
            overflow-y: auto;
            font-size: 14px;
        }

        #phoneChoices {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .phone-btn {
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        .phone-good {
            background: #27ae60;
            color: white;
        }

        .phone-bad {
            background: #c0392b;
            color: white;
        }

        /* kleine instructietekst in scene */
        .label {
            font-family: Arial;
            font-size: 18px;
            color: #ffffff;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
        }
    </style>
</head>

<body>
    <div id="panel">
        <div id="message"></div>
        <div id="ui"></div>
    </div>
    <button id="reset" class="btn">Reset</button>
    <button id="readQuestion">Lees vraag</button>

    <div id="phone">
        <div id="phoneScreen">112 centrale: Wat is uw noodmelding?</div>
        <div id="phoneChoices"></div>
    </div>

    <a-scene collision-check background="color: #aed9ff">
        <!-- Camera: spawn recht tegenover slachtoffer (spawn z=6) -->
        <a-entity id="cameraRig" position="0 0 6">
            <a-entity camera look-controls wasd-controls position="0 1.6 0">
                <a-entity cursor="fuse: true; fuseTimeout: 900" position="0 0 -1"
                    geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                    material="color: black; shader: flat">
                </a-entity>
            </a-entity>
        </a-entity>

        <!-- Stad: straat, stoep en curb -->
        <!-- Road: textured-like asphalt + sidewalks + curbs + lane markings (no external assets required) -->
        <a-plane rotation="-90 0 0" width="14" height="40" color="#262626" position="0 0.01 0"></a-plane>
        <!-- asphalt base -->

        <!-- sidewalks with slight elevation -->
        <a-box position="-4.6 0.05 0" width="3.2" depth="40" height="0.1" color="#e6e9ec"></a-box>
        <a-box position="4.6 0.05 0" width="3.2" depth="40" height="0.1" color="#e6e9ec"></a-box>

        <!-- curbs (thin raised edges) -->
        <a-box position="-3.05 0.12 -10" width="0.2" depth="40" height="0.14" color="#bfc9cf"></a-box>
        <a-box position="3.05 0.12 -10" width="0.2" depth="40" height="0.14" color="#bfc9cf"></a-box>

        <!-- center dashed line (generated with repeated small white planes) -->
        <a-entity id="dashed-line">
            <!-- create a set of short white segments -->
            <!-- using a loop client-side would be cleaner, but static segments are fine -->
            <a-box position="0 0.031  -18" width="0.12" depth="2.2" height="0.02" color="#ffffff"
                material="opacity:0.85"></a-box>
            <a-box position="0 0.031  -14" width="0.12" depth="2.2" height="0.02" color="#ffffff"
                material="opacity:0.85"></a-box>
            <a-box position="0 0.031  -10" width="0.12" depth="2.2" height="0.02" color="#ffffff"
                material="opacity:0.85"></a-box>
            <a-box position="0 0.031  -6" width="0.12" depth="2.2" height="0.02" color="#ffffff"
                material="opacity:0.85"></a-box>
            <a-box position="0 0.031  -2" width="0.12" depth="2.2" height="0.02" color="#ffffff"
                material="opacity:0.85"></a-box>
            <a-box position="0 0.031   2" width="0.12" depth="2.2" height="0.02" color="#ffffff"
                material="opacity:0.85"></a-box>
            <a-box position="0 0.031   6" width="0.12" depth="2.2" height="0.02" color="#ffffff"
                material="opacity:0.85"></a-box>
            <a-box position="0 0.031  10" width="0.12" depth="2.2" height="0.02" color="#ffffff"
                material="opacity:0.85"></a-box>
            <a-box position="0 0.031  14" width="0.12" depth="2.2" height="0.02" color="#ffffff"
                material="opacity:0.85"></a-box>
        </a-entity>

        <!-- small grassy verges -->
        <a-plane rotation="-90 0 0" width="40" height="10" color="#7fcf6f" position="0 0 -28"></a-plane>

        <!-- Lantaarnpalen op stoep (nu met lampkop en licht) -->
        <a-entity id="lamps">
            <!-- left lamps (op stoep, x = -4.6) -->
            <a-entity position="-4.6 0 -8">
                <a-cylinder radius="0.05" height="2.2" color="#3b3b3b" position="0 1.1 0"></a-cylinder>
                <a-sphere position="0 2.12 0" radius="0.16" color="#fff7d1"
                    material="emissive: #fff7d1; emissiveIntensity: 1"></a-sphere>
                <a-light type="point" color="#fff7d1" intensity="1.4" distance="8" position="0 2.12 0"></a-light>
            </a-entity>
            <a-entity position="-4.6 0 -2">
                <a-cylinder radius="0.05" height="2.2" color="#3b3b3b" position="0 1.1 0"></a-cylinder>
                <a-sphere position="0 2.12 0" radius="0.16" color="#fff7d1"
                    material="emissive: #fff7d1; emissiveIntensity: 1"></a-sphere>
                <a-light type="point" color="#fff7d1" intensity="1.4" distance="8" position="0 2.12 0"></a-light>
            </a-entity>

            <!-- right lamps (op stoep, x = 4.6) -->
            <a-entity position="4.6 0 8">
                <a-cylinder radius="0.05" height="2.2" color="#3b3b3b" position="0 1.1 0"></a-cylinder>
                <a-sphere position="0 2.12 0" radius="0.16" color="#fff7d1"
                    material="emissive: #fff7d1; emissiveIntensity: 1"></a-sphere>
                <a-light type="point" color="#fff7d1" intensity="1.4" distance="8" position="0 2.12 0"></a-light>
            </a-entity>
            <a-entity position="4.6 0 2">
                <a-cylinder radius="0.05" height="2.2" color="#3b3b3b" position="0 1.1 0"></a-cylinder>
                <a-sphere position="0 2.12 0" radius="0.16" color="#fff7d1"
                    material="emissive: #fff7d1; emissiveIntensity: 1"></a-sphere>
                <a-light type="point" color="#fff7d1" intensity="1.4" distance="8" position="0 2.12 0"></a-light>
            </a-entity>
        </a-entity>

        <!-- Platte gebouwen rondom (langs de weg, niet op de rijbaan) -->
        <!-- left side buildings -->
        <a-box position="-9 1.3 10" width="6" height="2.6" depth="6" color="#2f4b60"></a-box>
        <a-box position="-9 1.2 14" width="4" height="2.4" depth="5" color="#3b7a9e"></a-box>
        <a-box position="-9 1.2 18" width="5" height="2.4" depth="6" color="#6c7a89"></a-box>

        <!-- right side buildings -->
        <a-box position="9 1.3 12" width="6" height="2.6" depth="5" color="#4a6a7a"></a-box>
        <a-box position="9 1.1 8" width="5" height="2.2" depth="4" color="#2b3b45"></a-box>

        <!-- Auto (oorzaak van het ongeval) -->
        <!-- Auto start nu aan de andere kant van de weg (z = -25) -->
        <a-entity id="car" position="0 0 -25" rotation="0 0 0">
            <a-box depth="2" height="0.6" width="1.2" color="#c0392b" position="0 0.6 0"></a-box>
            <a-box depth="1.2" height="0.4" width="1" color="#e74c3c" position="0 1.0 0"></a-box>
            <a-cylinder radius="0.3" height="0.2" color="#2c3e50" rotation="90 0 0" position="0.6 0.3 0.9"></a-cylinder>
            <a-cylinder radius="0.3" height="0.2" color="#2c3e50" rotation="90 0 0"
                position="-0.6 0.3 0.9"></a-cylinder>
            <a-cylinder radius="0.3" height="0.2" color="#2c3e50" rotation="90 0 0"
                position="0.6 0.3 -0.9"></a-cylinder>
            <a-cylinder radius="0.3" height="0.2" color="#2c3e50" rotation="90 0 0"
                position="-0.6 0.3 -0.9"></a-cylinder>
        </a-entity>

        <!-- Persoon (realistischer opgebouwd uit meerdere primitives) -->
        <a-entity id="person" position="0 0 0">
            <!-- torso (houd id body voor scripts) -->
            <a-cylinder id="body" radius="0.28" height="0.9" color="#e0a66f" position="0 0.55 0"></a-cylinder>
            <!-- head -->
            <a-sphere radius="0.22" color="#f0c090" position="0 1.15 0"></a-sphere>
            <!-- arms -->
            <a-cylinder radius="0.06" height="0.7" color="#e0a66f" position="-0.38 0.8 0"
                rotation="0 0 45"></a-cylinder>
            <a-cylinder radius="0.06" height="0.7" color="#e0a66f" position="0.38 0.8 0"
                rotation="0 0 -45"></a-cylinder>
            <!-- legs -->
            <a-cylinder radius="0.07" height="0.8" color="#34495e" position="-0.12 0.1 0" rotation="0 0 0"></a-cylinder>
            <a-cylinder radius="0.07" height="0.8" color="#34495e" position="0.12 0.1 0" rotation="0 0 0"></a-cylinder>
            <!-- clothing / jacket layer -->
            <a-box width="0.6" height="0.05" depth="0.4" color="#2c3e50" position="0 0.75 0"></a-box>
            <!-- visible wound (houd id 'wound') -->
            <a-sphere id="wound" radius="0.12" color="#c0392b" position="0 0.95 0.22"></a-sphere>
        </a-entity>

        <!-- EHBO-kist naast slachtoffer -->
        <a-box id="ehbo" width="0.45" height="0.22" depth="0.3" color="#e74c3c" position="0.8 0 1.2"
            visible="false"></a-box>

        <!-- Spray en Pleister (komen op de EHBO-doos te liggen) -->
        <a-cylinder id="spray" radius="0.12" height="0.4" color="#3498db" position="0.4 0.2 1.4" class="interactable"
            visible="false"></a-cylinder>
        <a-text id="sprayLabel" value="Spray" align="center" color="#fff" position="0.4 0.65 1.4" scale="0.6 0.6 0.6"
            visible="false"></a-text>

        <a-box id="plaster" width="0.28" height="0.08" depth="0.14" color="#f7dc6f" position="1.2 0.04 1.4"
            class="interactable" visible="false"></a-box>
        <a-text id="plasterLabel" value="Pleister" align="center" color="#111" position="1.2 0.6 1.4"
            scale="0.6 0.6 0.6" visible="false"></a-text>

        <!-- Ambulance (komt vanaf andere kant dan de impact) -->
        <a-entity id="ambulance" position="0 0 25" rotation="0 180 0" visible="false">
            <a-box depth="2.5" height="1.2" width="1.6" color="#f1c40f" position="0 0.6 0"></a-box>
            <a-box width="1.6" height="0.2" depth="0.15" color="#d35400" position="0 0.25 1.1"></a-box>
            <a-cylinder radius="0.3" height="0.2" color="#2c3e50" rotation="90 0 0" position="0.7 0.3 1"></a-cylinder>
            <a-cylinder radius="0.3" height="0.2" color="#2c3e50" rotation="90 0 0" position="-0.7 0.3 1"></a-cylinder>
            <a-cylinder radius="0.3" height="0.2" color="#2c3e50" rotation="90 0 0" position="0.7 0.3 -1"></a-cylinder>
            <a-cylinder radius="0.3" height="0.2" color="#2c3e50" rotation="90 0 0" position="-0.7 0.3 -1"></a-cylinder>
            <a-sphere id="siren" radius="0.15" color="red" position="0 1.3 0">
                <a-animation attribute="color" values="red;blue;red" dur="500" repeat="indefinite"></a-animation>
            </a-sphere>
        </a-entity>

        <!-- Twee medics (verborgen, verschijnen bij ambulance) -->
        <a-entity id="medic1" position="0.6 0 25" visible="false">
            <a-sphere radius="0.18" color="#2ecc71" position="0 1 0"></a-sphere>
            <a-box width="0.25" height="0.5" depth="0.2" color="#145a32" position="0 0.35 0"></a-box>
        </a-entity>
        <a-entity id="medic2" position="-0.6 0 25" visible="false">
            <a-sphere radius="0.18" color="#2ecc71" position="0 1 0"></a-sphere>
            <a-box width="0.25" height="0.5" depth="0.2" color="#145a32" position="0 0.35 0"></a-box>
        </a-entity>

        <!-- Waarschuwingsdriehoek -->
        <a-entity id="triangle" visible="false">
            <a-cone radius-bottom="0.8" radius-top="0" height="1" color="#f1c40f" position="0 0.5 0"></a-cone>
            <a-cone radius-bottom="0.6" radius-top="0" height="0.9" color="#ffffff" position="0 0.51 0"></a-cone>
        </a-entity>

        <!-- gaze targets (balletjes) - iets verder voor de spawn zodat gebruiker ze direct ziet -->
        <a-sphere id="lookLeft" color="#ffd166" radius="0.22" position="-1.2 1.6 6.6" class="gazeTarget"
            visible="true"></a-sphere>
        <a-sphere id="lookRight" color="#ffd166" radius="0.22" position="1.2 1.6 6.6" class="gazeTarget"
            visible="true"></a-sphere>
        <a-text id="lookHint" value="Kijk eerst links en rechts naar de balletjes om je omgeving te checken"
            align="center" color="#fff" position="0 2 6.6" scale="0.95 0.95 0.95" visible="true"></a-text>

        <!-- Licht -->
        <a-entity light="type: ambient; intensity: 0.8"></a-entity>
        <a-entity light="type: directional; intensity: 0.6" position="0 10 5"></a-entity>
    </a-scene>

    <script>
        const panel = document.getElementById('panel');
        const ui = document.getElementById('ui');
        const message = document.getElementById('message');
        const body = document.getElementById('body');
        const ambulance = document.getElementById('ambulance');
        const triangle = document.getElementById('triangle');
        const car = document.getElementById('car');
        const resetBtn = document.getElementById('reset');
        const person = document.getElementById('person');
        const cameraRig = document.getElementById('cameraRig');
        const phone = document.getElementById('phone');
        const phoneScreen = document.getElementById('phoneScreen');
        const phoneChoices = document.getElementById('phoneChoices');
        const ehbo = document.getElementById('ehbo');
        const wound = document.getElementById('wound');
        const readQ = document.getElementById('readQuestion');
        const lookLeft = document.getElementById('lookLeft');
        const lookRight = document.getElementById('lookRight');
        const spray = document.getElementById('spray');
        const plaster = document.getElementById('plaster');
        const sprayLabel = document.getElementById('sprayLabel');
        const plasterLabel = document.getElementById('plasterLabel');
        const medic1 = document.getElementById('medic1');
        const medic2 = document.getElementById('medic2');

        let step = 0;
        let crashed = false;
        let carMoving = false;
        let ehboPicked = false;
        let woundDisinfected = false;
        let plasterApplied = false;
        let lookedLeft = false;
        let lookedRight = false;
        let heldItem = null; // 'spray' or 'plaster'
        let ambulanceEnRoute = false;
        let ambulanceArriving = false;

        function showPanel(html, options = []) {
            message.innerHTML = html;
            ui.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.textContent = opt.text;
                btn.className = 'btn ' + (opt.good ? 'btn-ok' : 'btn-bad');
                btn.onclick = opt.action;
                ui.appendChild(btn);
            });
            panel.style.display = 'block';
        }

        function showFeedback(text, isGood, next) {
            message.innerHTML = text;
            ui.innerHTML = '';
            const btn = document.createElement('button');
            btn.textContent = isGood ? 'Verder' : 'Opnieuw proberen';
            btn.className = 'btn ' + (isGood ? 'btn-ok' : 'btn-bad');
            btn.onclick = () => {
                panel.style.display = 'none';
                if (isGood && typeof next === 'function') next();
                if (!isGood) reset();
            };
            ui.appendChild(btn);
            panel.style.display = 'block';
        }

        // vervang of voeg toe: vraag-interface zonder hints vooraf
        function showQuestion(html, choices = []) {
            message.innerHTML = html;
            ui.innerHTML = '';
            // choices: [{ text: '...', correct: true/false, feedback: '...','next': fn }]
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.textContent = choice.text;
                btn.className = 'btn btn-neutral';
                btn.onclick = () => evaluateAnswer(choice);
                ui.appendChild(btn);
            });
            panel.style.display = 'block';
        }

        function evaluateAnswer(choice) {
            panel.style.display = 'none'; // hide question while showing feedback
            if (choice.correct) {
                showFeedback('✅ ' + (choice.feedback || 'Goed gedaan.'), true, () => {
                    if (typeof choice.next === 'function') choice.next();
                });
            } else {
                // toon korte uitleg waarom het niet goed is, maar reveal geen hint vóór kiezen
                showFeedback('❌ ' + (choice.feedback || 'Dit is niet de beste keuze.'), false, () => {
                    // on wrong: ga niet automatisch verder — laat gebruiker opnieuw kiezen of herstart
                    if (choice.retry === true) {
                        panel.style.display = 'none';
                        // open same question again if provided
                        if (typeof choice.repeat === 'function') choice.repeat();
                    } else if (typeof choice.next === 'function') {
                        choice.next();
                    }
                });
            }
        }

        // start crash: auto rijdt van andere kant (z negatief) naar het slachtoffer (richting +z)
        function startCrash() {
            carMoving = true;
            // ensure car faces +z (rotation 0 0 0) and komt van z = -25
            car.setAttribute('rotation', '0 0 0');
            const from = car.getAttribute('position');
            const fromStr = `${from.x} ${from.y} ${from.z}`;
            // eindigt iets vóór het slachtoffer (niet eroverheen), net voor z ≈ 0
            car.setAttribute('animation__drive', `property: position; from: ${fromStr}; to: 0 0 -0.6; dur: 3800; easing: linear`);
        }

        // Komponenten voor interactiviteit
        AFRAME.registerComponent('gaze-trigger', {
            schema: { id: { type: 'string' } },
            init: function () {
                const el = this.el;
                el.addEventListener('click', () => {
                    const id = this.data.id;
                    if (id === 'left') {
                        lookedLeft = true;
                        el.setAttribute('color', '#9ae6b4');
                        el.setAttribute('scale', '1.3 1.3 1.3');
                    } else {
                        lookedRight = true;
                        el.setAttribute('color', '#9ae6b4');
                        el.setAttribute('scale', '1.3 1.3 1.3');
                    }
                    // als beide bekeken: verberg balletjes en ga verder INPLAATS VAN TELEPORT
                    if (lookedLeft && lookedRight) {
                        lookLeft.setAttribute('visible', false);
                        lookRight.setAttribute('visible', false);
                        document.getElementById('lookHint').setAttribute('visible', false);
                        // Laat gebruiker zelf naar slachtoffer lopen — ga direct verder in de flow
                        nextStep();
                    }
                });
            }
        });

        // Glow-component voor interactables
        AFRAME.registerComponent('glow', {
            schema: { active: { type: 'boolean', default: false } },
            init: function () {
                this.animId = null;
            },
            update: function () {
                if (this.data.active) {
                    // pulse scale & color
                    this.el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 800; to: 1.12 1.12 1.12; loop: true');
                    this.el.setAttribute('animation__color', 'property: color; dir: alternate; dur: 800; to: #ffffff; loop: true');
                } else {
                    this.el.removeAttribute('animation__pulse');
                    this.el.removeAttribute('animation__color');
                    this.el.setAttribute('scale', '1 1 1');
                }
            }
        });

        // Pick-up / hold with mouse/touch/cursor (klikken pakt het object vast)
        AFRAME.registerComponent('pickable', {
            init: function () {
                const el = this.el;
                function tryPickup() {
                    // only allow pickup when items zijn usable (EHBO stage)
                    if (step >= 4 && !heldItem && el.getAttribute('visible') === true) {
                        heldItem = el.getAttribute('id');
                        // attach to camera so user 'holds' it
                        try {
                            // reparent to camera (camera is inside cameraRig)
                            const scene = document.querySelector('a-scene');
                            // remove from current parent (if possible)
                            if (el.object3D && el.object3D.parent) el.object3D.parent.removeChild(el.object3D);
                            const cam = document.querySelector('[camera]').parentEl;
                            cam.appendChild(el);
                            el.setAttribute('position', '0 -0.12 -0.6');
                            el.setAttribute('rotation', '0 0 0');
                            el.setAttribute('scale', '0.9 0.9 0.9');
                            showFeedback('Je hebt de ' + (heldItem === 'spray' ? 'spraybus' : 'pleister') + ' gepakt. Klik op het slachtoffer om het te gebruiken.', true, () => { });
                            // disable glow while held
                            el.components['glow'] && el.setAttribute('glow', { active: false });
                        } catch (e) {
                            console.error('Cannot pick up element', e);
                        }
                    }
                }

                // support mouse/touch and A-Frame click events
                el.addEventListener('click', tryPickup);
                el.addEventListener('mousedown', tryPickup);
                el.addEventListener('touchstart', tryPickup);
            }
        });

        // klik op slachtoffer om gebruikt item toe te passen (negeer klikken vóór EHBO-stap / geen 'niets vast' melding)
        person.addEventListener('click', () => {
            if (step < 4) return; // stil genegeerd zolang EHBO nog niet beschikbaar is
            if (!heldItem) return; // geen feedback tonen wanneer niets vast
            if (heldItem === 'spray') {
                if (!woundDisinfected) {
                    wound.setAttribute('color', '#e67e22');
                    woundDisinfected = true;
                    // drop the spray back to spawn
                    dropItem('spray', { x: 0.4, y: 0.2, z: 1.4 });
                    heldItem = null;
                    showFeedback('✅ Wond gedesinfecteerd met spray.', true, () => {
                        // enable plaster glow now
                        updateGlows();
                    });
                } else {
                    showFeedback('De wond is al gedesinfecteerd.', true, () => { });
                }
            } else if (heldItem === 'plaster') {
                if (!woundDisinfected) {
                    showFeedback('❌ Eerst desinfecteren! Gebruik eerst de spray.', false);
                    return;
                }
                if (!plasterApplied) {
                    wound.setAttribute('visible', false);
                    plasterApplied = true;
                    dropItem('plaster', { x: 1.2, y: 0.04, z: 1.4 });
                    heldItem = null;
                    showFeedback('✅ Pleister aangebracht. De ambulance zal nu volledig arriveren.', true, () => {
                        // stop glow
                        plaster.setAttribute('glow', { active: false });
                        // verplaats EHBO-kist terug
                        ehbo.setAttribute('animation__close', 'property: position; to: 0.8 0 1.2; dur: 800; easing: easeInQuad');
                        setTimeout(() => {
                            ehbo.setAttribute('visible', false);
                            ehbo.removeAttribute('animation__close');
                            // trigger ambulance arrival (medics stappen uit en nemen de persoon mee)
                            triggerAmbulanceArrival();
                            // ga door naar de volgende stap (ambulance / vervolg)
                            setTimeout(() => nextStep(), 50);
                        }, 900);
                    });
                } else {
                    showFeedback('Pleister al aangebracht.', true);
                }
            }
        });

        function dropItem(id, pos) {
            const item = document.getElementById(id);
            // ensure item exists and reparent to scene
            const scene = document.querySelector('a-scene');
            item.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
            item.setAttribute('rotation', '0 0 0');
            item.setAttribute('scale', '1 1 1');
            scene.appendChild(item);
            // allow pickup again
            item.components['glow'] && item.setAttribute('glow', { active: false });
        }

        function updateGlows() {
            // items glow only when EHBO stage active and ambulance is en route
            const activeBase = (step >= 4 && ambulanceEnRoute);
            spray.setAttribute('glow', { active: (activeBase && !woundDisinfected) });
            plaster.setAttribute('glow', { active: (activeBase && woundDisinfected && !plasterApplied) });
            // highlight wound location in a distinct pulsing color while treatable
            const woundActive = (step >= 4 && ambulanceEnRoute && !woundDisinfected);
            if (woundActive) {
                // pulse scale + color to draw attention
                wound.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 700; to: 1.35 1.35 1.35; loop: true');
                wound.setAttribute('animation__color', 'property: color; dir: alternate; dur: 700; to: #ff6b6b; loop: true');
            } else {
                wound.removeAttribute('animation__pulse');
                wound.removeAttribute('animation__color');
                wound.setAttribute('scale', '1 1 1');
                wound.setAttribute('color', '#c0392b');
            }
        }

        // collision-check component: eenvoudige afstandscheck (werkt ongeacht zijde van benadering)
        AFRAME.registerComponent('collision-check', {
            tick: function () {
                if (!carMoving) return;
                const carPos = car.getAttribute('position');
                const personPos = person.getAttribute('position');
                const dx = carPos.x - personPos.x;
                const dz = carPos.z - personPos.z;
                const distance = Math.sqrt(dx * dx + dz * dz);
                // trigger botsing als dicht genoeg (ongeacht richting) en nog niet gebeurd
                if (distance < 1.2 && !crashed) {
                    crashed = true;
                    car.removeAttribute('animation__drive');
                    car.setAttribute('position', carPos);
                    carMoving = false;
                    // laat het slachtoffer vallen (rotatie + schuiven)
                    person.setAttribute('animation__fallrot', 'property: rotation; to: 90 0 -90; dur: 700; easing: easeOutQuad');
                    person.setAttribute('animation__fallpos', 'property: position; to: 0 0.15 -0.4; dur: 700; easing: easeOutQuad');
                    body.setAttribute('color', '#7f8c8d');
                    setTimeout(() => nextStep(), 1000);
                }
            }
        });

        function nextStep() {
            step++;
            // Zorg dat de 'Lees vraag' knop altijd de huidige vraag toont
            if (step === 1) {
                // Stap 1: eigen veiligheid -> gaze check
                showPanel(
                    '<strong>🩺 Stap 1 – Let op je eigen veiligheid</strong><br><br>' +
                    'Situatie:\nJe ziet een voetganger op de grond liggen. Er rijden nog auto’s voorbij.<br><br>' +
                    'Interactief: Kijk eerst naar de linker en rechter marker (kijk naar de balletjes) om de weg te checken.',
                    [
                        {
                            text: 'Ik begrijp het', good: true, action: () => {
                                panel.style.display = 'none';
                                // show gaze markers and enable components
                                lookLeft.setAttribute('visible', true);
                                lookRight.setAttribute('visible', true);
                                lookLeft.setAttribute('gaze-trigger', { id: 'left' });
                                lookRight.setAttribute('gaze-trigger', { id: 'right' });
                            }
                        }
                    ]);
            }
            else if (step === 2) {
                // Stap 2: doe dit nu als echte vraag zonder hints op de knoppen
                showQuestion(
                    '<strong>🗣️ Stap 2 – Kijk of de persoon aanspreekbaar is</strong><br><br>' +
                    'Wat is de eerste en beste actie om te controleren of iemand aanspreekbaar is?',
                    [
                        {
                            text: 'A. Je vraagt rustig: “Gaat het met u?”', correct: true, feedback: 'Juist — rustig spreken is de juiste eerste stap.', next: () => {
                                body.setAttribute('position', '0 0.3 0'); nextStep();
                            }
                        },
                        { text: 'B. Je schudt de persoon stevig aan de schouders', correct: false, feedback: 'Schudden kan gevaarlijk zijn; probeer eerst verbaal contact.' },
                        { text: 'C. Je roept in paniek om hulp', correct: false, feedback: 'Paniek helpt niet; blijf rustig en controleer aanspreekbaarheid.' }
                    ]
                );
            }
            else if (step === 3) {
                showQuestion(
                    '<strong>☎️ Stap 3 – Bel 112</strong><br><br>' +
                    'Wat moet je doen zodra je vaststelt dat er mogelijk gewonden zijn?',
                    [
                        { text: 'A. Je belt 112 en vertelt wat er is gebeurd', correct: true, feedback: 'Juist — bel 112 en geef locatie en aantal gewonden door.', next: () => openPhone() },
                        { text: 'B. Je wacht even of hij zelf opstaat', correct: false, feedback: 'Wachten kost waardevolle tijd; bel altijd bij mogelijk ernstig letsel.' },
                        { text: 'C. Je zoekt iemand anders die misschien wil bellen', correct: false, feedback: 'Je kunt iemand vragen, maar jij bent aanwezig — bel direct.' }
                    ]
                );
            }
            else if (step === 4) {
                // EHBO stap: items zichtbaar nadat 112 is gestart (en ambulance en route)
                showPanel(
                    '<strong>🧰 Stap 4 – EHBO: pak spray en pleister</strong><br><br>' +
                    'Situatie:\nEr ligt een EHBO-doos naast het slachtoffer met een spraybus en pleister. Klik op de spullen om ze te pakken en behandel de wond terwijl de hulp onderweg is.',
                    [
                        {
                            text: 'Ga naar de EHBO spullen', good: true, action: () => {
                                panel.style.display = 'none';
                                // zet EHBO-kist en items zichtbaar bij slachtoffer
                                ehbo.setAttribute('visible', true);
                                spray.setAttribute('visible', true);
                                plaster.setAttribute('visible', true);
                                sprayLabel.setAttribute('visible', true);
                                plasterLabel.setAttribute('visible', true);
                                // maak items nu pas interactief en zet glow-standaard
                                spray.setAttribute('pickable', '');
                                plaster.setAttribute('pickable', '');
                                spray.setAttribute('glow', { active: false });
                                plaster.setAttribute('glow', { active: false });
                                // pickable-component aanwezig; glow activeert zodra ambulanceEnRoute true
                                updateGlows();
                            }
                        },
                        {
                            text: 'Wachten op ambulance', good: false, action: () => {
                                gameOver('Wachten kost tijd. Kleine handelingen zoals desinfecteren kunnen wél levensreddend zijn.');
                            }
                        }
                    ]
                );
            }
            else if (step === 5) {
                // ambulance is onderweg (maar full arrival waits until pleister)
                showPanel(
                    '<strong>🚑 Ambulance onderweg</strong><br><br>' +
                    'De ambulance is onderweg. Je hebt nu tijd om de wond te behandelen: pak de spray en daarna de pleister.',
                    [
                        {
                            text: 'Ik ga behandelen', good: true, action: () => {
                                panel.style.display = 'none';
                                // laat items gloeien (beschikbaar) als ambulanceEnRoute true
                                updateGlows();
                            }
                        },
                        {
                            text: 'Ik blijf alleen bij slachtoffer', good: false, action: () => {
                                showFeedback('❌ Niet optimaal. Gebruik beschikbare middelen om tijdelijke zorg te bieden terwijl je wacht.', false);
                            }
                        }
                    ]
                );
            }
            else if (step === 6) {
                showPanel(
                    '<strong>❤️ Stap 6 – Blijf bij het slachtoffer</strong><br><br>' +
                    'De hulpverleners zijn ter plaatse. Blijf bij het slachtoffer en geef duidelijk informatie aan hulpdiensten bij aankomst.',
                    [
                        {
                            text: 'A. Je blijft erbij en praat rustig tot de hulpdiensten er zijn', good: true, action: () => {
                                showFeedback('✅ Goed!<br>Blijf bij het slachtoffer, stel hem gerust en wacht op de hulpdiensten.', true, () => win());
                            }
                        },
                        {
                            text: 'B. Je loopt de ambulance tegemoet en laat hem even alleen', good: false, action: () => {
                                gameOver('Laat iemand nooit alleen of bewegen als hij gewond is.');
                            }
                        }
                    ]);
            }
        }

        function showEhboActions() {
            showPanel(
                '<strong>✋ Behandel de wond</strong><br><br>' +
                'Gebruik de spray eerst, daarna pleister.',
                [
                    {
                        text: 'Desinfecteer wond', good: true, action: () => {
                            if (!ehboPicked) { showFeedback('❌ Je hebt nog geen EHBO-kist gepakt.', false); return; }
                            if (woundDisinfected) { showFeedback('✅ Al gedesinfecteerd.', true, () => showEhboActions()); return; }
                            wound.setAttribute('color', '#e67e22');
                            woundDisinfected = true;
                            showFeedback('✅ Wond gedesinfecteerd.', true, () => showEhboActions());
                        }
                    },
                    {
                        text: 'Pleister aanbrengen', good: true, action: () => {
                            if (!ehboPicked) { showFeedback('❌ Je hebt nog geen EHBO-kist gepakt.', false); return; }
                            if (!woundDisinfected) { showFeedback('❌ Eerst desinfecteren, daarna pleisteren.', false); return; }
                            if (plasterApplied) { showFeedback('✅ Pleister al aangebracht.', true, () => showEhboActions()); return; }
                            wound.setAttribute('visible', false);
                            plasterApplied = true;
                            showFeedback('✅ Pleister aangebracht. De wond is tijdelijk verzorgd.', true, () => {
                                ehbo.setAttribute('animation__close', 'property: position; to: 0.8 0 1.2; dur: 800; easing: easeInQuad');
                                setTimeout(() => {
                                    ehbo.setAttribute('visible', false);
                                    ehbo.removeAttribute('animation__close');
                                    // start ambulance full arrival
                                    triggerAmbulanceArrival();
                                }, 900);
                            });
                        }
                    }
                ]
            );
        }

        // Open phone UI: toon toetsenbord zodat gebruiker zelf 112 kan intoetsen
        function openPhone() {
            panel.style.display = 'none';
            phone.style.display = 'flex';
            phoneScreen.textContent = "Toets noodnummer:";
            phoneChoices.innerHTML = '';

            // display number line
            const numLine = document.createElement('div');
            numLine.id = 'phoneNumber';
            numLine.style.fontSize = '28px';
            numLine.style.textAlign = 'center';
            numLine.style.padding = '6px 0 12px 0';
            numLine.textContent = '';
            phoneChoices.appendChild(numLine);

            // keypad
            const keypad = document.createElement('div');
            keypad.style.display = 'grid';
            keypad.style.gridTemplateColumns = 'repeat(3, 1fr)';
            keypad.style.gap = '8px';
            keypad.style.marginBottom = '10px';
            const digits = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '*', '0', '#'];
            digits.forEach(d => {
                const b = document.createElement('button');
                b.textContent = d;
                b.className = 'phone-btn phone-good';
                b.style.padding = '12px 6px';
                b.onclick = () => {
                    numLine.textContent = (numLine.textContent + d).slice(0, 6); // max lengte
                };
                keypad.appendChild(b);
            });
            phoneChoices.appendChild(keypad);

            // controls row: clear, call, close
            const controls = document.createElement('div');
            controls.style.display = 'flex';
            controls.style.gap = '8px';
            const clearBtn = document.createElement('button');
            clearBtn.textContent = 'Clear';
            clearBtn.className = 'phone-btn phone-bad';
            clearBtn.onclick = () => { numLine.textContent = ''; };
            const callBtn = document.createElement('button');
            callBtn.textContent = 'Bellen';
            callBtn.className = 'phone-btn phone-good';
            callBtn.onclick = () => {
                const number = numLine.textContent;
                if (number === '112') {
                    // correct: ga door
                    phoneScreen.textContent = "112 centrale: Verbonden. Wat is uw noodmelding?";
                    phoneChoices.innerHTML = '';
                    setTimeout(() => phoneStep2(), 600);
                } else {
                    phoneScreen.textContent = '112 centrale: Ongeldig nummer. Probeer opnieuw.';
                    setTimeout(() => {
                        phoneScreen.textContent = "Toets noodnummer:";
                        numLine.textContent = '';
                    }, 1200);
                }
            };
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Sluiten';
            closeBtn.className = 'phone-btn';
            closeBtn.onclick = () => { phone.style.display = 'none'; };
            controls.appendChild(clearBtn);
            controls.appendChild(callBtn);
            controls.appendChild(closeBtn);
            phoneChoices.appendChild(controls);
        }

        function phoneStep2() {
            phoneScreen.textContent = "112 centrale: Zijn er gewonden?";
            phoneChoices.innerHTML = '';
            const yes = document.createElement('button');
            yes.textContent = "Ja, een persoon is aangereden";
            yes.className = 'phone-btn phone-good';
            yes.onclick = () => {
                phoneScreen.textContent = "112 centrale: Een ambulance wordt gestuurd.";
                phoneChoices.innerHTML = '';
                setTimeout(() => {
                    phone.style.display = 'none';
                    startAmbulanceRun();
                    // ga naar EHBO stap
                    setTimeout(() => nextStep(), 50);
                }, 800);
            };
            const no = document.createElement('button');
            no.textContent = "Nee, alleen blikschade";
            no.className = 'phone-btn phone-bad';
            no.onclick = () => {
                phoneScreen.textContent = "112 centrale: De centralist stuurt geen ambulance.";
                phoneChoices.innerHTML = '';
                const retry = document.createElement('button');
                retry.textContent = "Opnieuw proberen";
                retry.className = 'phone-btn phone-good';
                retry.onclick = () => { phone.style.display = 'none'; reset(); };
                phoneChoices.appendChild(retry);
            };
            phoneChoices.appendChild(yes);
            phoneChoices.appendChild(no);
        }

        // Start ambulance 'en route' — nadert, maar arriveert pas volledig na pleister
        function startAmbulanceRun() {
            ambulanceEnRoute = true;
            ambulance.setAttribute('visible', true);
            ehbo.setAttribute('visible', true);
            // Laat ambulance naar tussenpositie komen (zichtbaar naderend)
            ambulance.setAttribute('animation__toward', 'property: position; from: 0 0 25; to: 0 0 12; dur: 9000; easing: linear');
            sprayLabel.setAttribute('visible', true);
            plasterLabel.setAttribute('visible', true);
            updateGlows();
        }

        // Wanneer pleister is geplaatst: laat ambulance volledig arriveren en start medics-sequentie
        function triggerAmbulanceArrival() {
            if (!ambulanceEnRoute || ambulanceArriving) return;
            ambulanceArriving = true;
            // stop tussen-animatie en rij naar finale positie
            ambulance.removeAttribute('animation__toward');
            const current = ambulance.getAttribute('position');
            const fromStr = `${current.x} ${current.y} ${current.z}`;
            ambulance.setAttribute('animation__arrive', `property: position; from: ${fromStr}; to: 0 0 3; dur: 7000; easing: linear`);
            // Zorg dat medics-sequentie start na aankomst
            setTimeout(() => {
                ambulance.removeAttribute('animation__arrive');
                ambulance.setAttribute('position', '0 0 3');
                ambulanceArrivedSequence();
            }, 7200);
        }

        function ambulanceArrivedSequence() {
            // medics stap naar slachtoffer
            medic1.setAttribute('visible', true);
            medic2.setAttribute('visible', true);
            // animate medics to positions near person
            medic1.setAttribute('animation__walk', 'property: position; to: 0.6 0 0.6; dur: 1600; easing: easeInOutQuad');
            medic2.setAttribute('animation__walk', 'property: position; to: -0.6 0 0.6; dur: 1600; easing: easeInOutQuad');
            setTimeout(() => {
                medic1.removeAttribute('animation__walk');
                medic2.removeAttribute('animation__walk');
                // simulate taking the person: move person slightly and then back to ambulance
                person.setAttribute('animation__lift', 'property: position; to: 0 0 0.6; dur: 600; easing: easeOutQuad');
                setTimeout(() => {
                    person.removeAttribute('animation__lift');
                    // medics carry person back to ambulance
                    medic1.setAttribute('animation__carry', 'property: position; to: 0.6 0 3; dur: 2000; easing: linear');
                    medic2.setAttribute('animation__carry', 'property: position; to: -0.6 0 3; dur: 2000; easing: linear');
                    person.setAttribute('animation__tow', 'property: position; to: 0 0 3; dur: 2000; easing: linear');
                    setTimeout(() => {
                        // hide person (in ambulance) and medics after loading
                        person.setAttribute('visible', false);
                        medic1.setAttribute('visible', false);
                        medic2.setAttribute('visible', false);
                        medic1.removeAttribute('animation__carry');
                        medic2.removeAttribute('animation__carry');
                        person.removeAttribute('animation__tow');
                        // ambulance rijdt weg
                        ambulance.setAttribute('animation__away', 'property: position; to: 0 0 40; dur: 4000; easing: linear');
                        setTimeout(() => {
                            // einde van sequentie -> volgende stap (afsluitende fase)
                            nextStep();
                        }, 4000);
                    }, 2100);
                }, 700);
            }, 1700);
        }

        function gameOver(text) {
            body.setAttribute('color', '#7f8c8d');
            showPanel('<strong>GAME OVER</strong><br><br>' + text, [{ text: 'Opnieuw proberen', good: true, action: () => reset() }]);
        }

        function win() {
            body.setAttribute('color', '#2ecc71');
            body.setAttribute('position', '0 0.6 0');
            showPanel('<strong>Goed gedaan!</strong><br><br>Je hebt de juiste stappen gevolgd en het slachtoffer ondersteund tot de hulpdiensten er waren.', [{ text: 'Opnieuw spelen', good: true, action: () => reset() }]);
        }

        function reset() {
            step = 0; crashed = false; carMoving = false;
            // zet auto aan de andere kant (z = -25) zodat hij van de andere kant komt
            car.setAttribute('position', '0 0 -25'); car.setAttribute('rotation', '0 0 0');
            // spawn: recht tegenover slachtoffer (jet gebruiker kan zelf lopen)
            cameraRig.setAttribute('position', '0 0 6');
            body.setAttribute('color', '#f1c40f'); body.setAttribute('position', '0 0.6 0'); body.setAttribute('rotation', '0 0 0');
            triangle.setAttribute('visible', false); triangle.removeAttribute('animation');
            ambulance.setAttribute('visible', false); ambulance.setAttribute('position', '0 0 25'); ambulance.removeAttribute('animation'); ambulance.removeAttribute('animation__away');
            ehbo.setAttribute('visible', false); ehbo.setAttribute('position', '0.8 0 1.2'); ehbo.removeAttribute('animation');
            ehboPicked = false; woundDisinfected = false; plasterApplied = false;
            ambulanceEnRoute = false; ambulanceArriving = false;
            wound.setAttribute('visible', true); wound.setAttribute('color', '#c0392b'); wound.setAttribute('position', '0 0.95 0.22');
            panel.style.display = 'none'; phone.style.display = 'none';
            // reset gaze targets and flags -> zichtbaar in begin
            lookedLeft = false; lookedRight = false;
            lookLeft.setAttribute('visible', true); lookLeft.setAttribute('color', '#ffd166'); lookLeft.setAttribute('scale', '1 1 1'); lookLeft.setAttribute('position', '-1.2 1.6 6');
            lookRight.setAttribute('visible', true); lookRight.setAttribute('color', '#ffd166'); lookRight.setAttribute('scale', '1 1 1'); lookRight.setAttribute('position', '1.2 1.6 6');
            document.getElementById('lookHint').setAttribute('visible', true); document.getElementById('lookHint').setAttribute('position', '0 2 6');
            // reset EHBO items positions and parent (naast ehbo)
            const scene = document.querySelector('a-scene');
            spray.setAttribute('position', '0.4 0.2 1.4'); spray.setAttribute('rotation', '0 0 0'); spray.setAttribute('scale', '1 1 1'); scene.appendChild(spray);
            plaster.setAttribute('position', '1.2 0.04 1.4'); plaster.setAttribute('rotation', '0 0 0'); plaster.setAttribute('scale', '1 1 1'); scene.appendChild(plaster);
            spray.setAttribute('visible', false); plaster.setAttribute('visible', false);
            sprayLabel.setAttribute('visible', false); plasterLabel.setAttribute('visible', false);
            spray.setAttribute('glow', { active: false }); plaster.setAttribute('glow', { active: false });
            heldItem = null;
            // reset medics
            medic1.setAttribute('visible', false); medic2.setAttribute('visible', false);
            medic1.setAttribute('position', '0.6 0 25'); medic2.setAttribute('position', '-0.6 0 25');
            person.setAttribute('visible', true); person.setAttribute('position', '0 0 0');
            // start crash sequence
            showPanel('<strong>Klaar?</strong><br><br>Het scenario start. Volg de instructies.', [{ text: 'Start', good: true, action: () => { panel.style.display = 'none'; startCrash(); } }]);
        }

        // 'Lees vraag' knop toont huidge panel (of opent huidige stap info)
        readQ.addEventListener('click', () => {
            if (panel.style.display === 'block') { panel.style.display = 'none'; return; }
            if (step === 0) {
                showPanel('<strong>Stap 1</strong><br>Kijk links en rechts naar de markers om te checken of het veilig is.', [{ text: 'Sluiten', good: true, action: () => { panel.style.display = 'none'; } }]);
            } else if (step === 1) {
                showPanel('<strong>Stap 1 (gaze)</strong><br>Kijk naar de balletjes links en rechts voordat je naar het slachtoffer gaat.', [{ text: 'Sluiten', good: true, action: () => { panel.style.display = 'none'; } }]);
            } else if (step === 2) {
                showPanel('<strong>Stap 2</strong><br>Kijk of het slachtoffer aanspreekbaar is.', [{ text: 'Sluiten', good: true, action: () => { panel.style.display = 'none'; } }]);
            } else if (step === 3) {
                showPanel('<strong>Stap 3</strong><br>Bel 112 en geef locatie en aantal gewonden door.', [{ text: 'Sluiten', good: true, action: () => { panel.style.display = 'none'; } }]);
            } else if (step >= 4) {
                showPanel('<strong>EHBO</strong><br>Pak beschikbare items (spray en pleister) van de EHBO-doos naast het slachtoffer. Gebruik spray eerst, daarna pleister.', [{ text: 'Sluiten', good: true, action: () => { panel.style.display = 'none'; } }]);
            } else {
                showPanel('<strong>Informatie</strong><br>Volg de instructies op het scherm.', [{ text: 'Sluiten', good: true, action: () => { panel.style.display = 'none'; } }]);
            }
        });

        resetBtn.onclick = reset;

        // initialisatie: voeg componenten toe aan gaze targets (items worden pas interactief in stap 4)
        lookLeft.setAttribute('gaze-trigger', { id: 'left' });
        lookRight.setAttribute('gaze-trigger', { id: 'right' });
        // spray/plaster blijven onzichtbaar en niet-pickable tot stap 4
        // begin
        reset();
    </script>
</body>

</html>